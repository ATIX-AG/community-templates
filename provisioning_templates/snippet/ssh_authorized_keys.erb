<%#
kind: snippet
name: ssh_authorized_keys
model: ProvisioningTemplate
snippet: true
-%>

<%#
SSH keys setup snippet

Parameters:

ssh_authorized_keys: public keys to be put in /root/.ssh/authorized_keys

This template sets up SSH keys in any host so that as long as your public
SSH key is in ssh_authorized_keys, you can SSH into a host.
-%>

<% unless host_param('ssh_authorized_keys').blank? -%>
<%   authorized_keys = host_param('ssh_authorized_keys')
     ssh_user = 'root'
     ssh_path = "~#{ssh_user}/.ssh"
-%>

mkdir -p <%= ssh_path %>
touch <%= ssh_path %>/authorized_keys

chmod 0700 <%= ssh_path %>
chmod 0600 <%= ssh_path %>/authorized_keys
chown -R <%= "#{ssh_user}:" %> <%= ssh_path %>

cat << EOF >> <%= ssh_path %>/authorized_keys
<%= authorized_keys.is_a?(String) ? authorized_keys : authorized_keys.join("\n") %>
EOF

# Restore SELinux context with restorecon, if it's available:
command -v restorecon && restorecon -RvF <%= ssh_path %> || true

<%- end %>
